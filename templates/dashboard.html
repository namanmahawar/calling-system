<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    thead th {
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 2;
    }
    .filter-input {
      font-size: 12px;
      padding: 2px 4px;
    }
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>

<body class="bg-light">
<div class="container-fluid p-3">

<!-- ================= HEADER ================= -->
<div class="text-center mb-3">
  <h3 class="fw-bold">{{ company_name }}</h3>
  <div class="text-muted">Calling & Follow-up Management System</div>
</div>

<!-- ================= FLASH MESSAGES ================= -->
{% with messages = get_flashed_messages() %}
  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-info no-print">{{ m }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ================= UPLOAD SECTION ================= -->
<div class="card mb-3 no-print">
  <div class="card-body">
    <div class="row g-3">

      <!-- Balance Upload -->
      <div class="col-md-6">
        <h6 class="fw-bold">ðŸ“¥ Upload Balance</h6>
        <form action="/upload/balance" method="post" enctype="multipart/form-data">
          <input type="file" name="file" class="form-control form-control-sm mb-2" required>
          <button class="btn btn-primary btn-sm">Upload</button>
          <button type="button" class="btn btn-outline-secondary btn-sm"
                  onclick="downloadBalanceSample()">Sample</button>
        </form>
        <small class="text-muted">Columns: Party Name | Closing Balance</small>
      </div>

      <!-- Contact Upload -->
      <div class="col-md-6">
        <h6 class="fw-bold">ðŸ“¥ Upload Contacts</h6>
        <form action="/upload/contacts" method="post" enctype="multipart/form-data">
          <input type="file" name="file" class="form-control form-control-sm mb-2" required>
          <button class="btn btn-success btn-sm">Upload</button>
          <button type="button" class="btn btn-outline-secondary btn-sm"
                  onclick="downloadContactSample()">Sample</button>
        </form>
        <small class="text-muted">Columns: Party Name | Mobile No (WhatsApp auto)</small>
      </div>

    </div>
  </div>
</div>

<!-- ================= ACTION BUTTONS ================= -->
<div class="d-flex gap-2 mb-3 no-print">
  <a href="/companies" class="btn btn-secondary btn-sm">
    <i class="bi bi-building"></i> Change Company
  </a>
  <button class="btn btn-success btn-sm" onclick="exportTable()">
    <i class="bi bi-file-earmark-arrow-down"></i> Export
  </button>
  <button class="btn btn-outline-dark btn-sm" onclick="window.print()">
    <i class="bi bi-printer"></i> Print
  </button>
  <a href="/logout" class="btn btn-danger btn-sm ms-auto">
    <i class="bi bi-box-arrow-right"></i> Logout
  </a>
</div>

<!-- ================= TABLE ================= -->
<div class="table-responsive">
<table class="table table-bordered table-hover align-middle" id="dataTable">

<thead>
<tr>
  <th>Sr</th>
  <th>Party</th>
  <th>Mobile</th>
  <th>WhatsApp</th>
  <th>Balance</th>
  <th>Narration</th>
  <th>Commit Date</th>
  <th class="no-print">Done</th>
  <th class="no-print">Actions</th>
</tr>

<!-- FILTER ROW -->
<tr class="no-print">
  <th></th>
  <th><input class="form-control filter-input" onkeyup="filterCol(1,this.value)"></th>
  <th><input class="form-control filter-input" onkeyup="filterCol(2,this.value)"></th>
  <th><input class="form-control filter-input" onkeyup="filterCol(3,this.value)"></th>
  <th><input class="form-control filter-input" onkeyup="filterCol(4,this.value)"></th>
  <th><input class="form-control filter-input" onkeyup="filterCol(5,this.value)"></th>
  <th><input type="date" class="form-control filter-input" onchange="filterCol(6,this.value)"></th>
  <th></th>
  <th></th>
</tr>
</thead>

<tbody>
{% for d in data %}
<tr>
  <td class="sr"></td>
  <td>{{ d[2] }}</td>
  <td>{{ d[3] or '' }}</td>
  <td>{% if d[4] %}Yes{% else %}No{% endif %}</td>
  <td>{{ d[5] }}</td>

  <td>
    <input class="form-control form-control-sm" value="{{ d[6] or '' }}" placeholder="Remarks">
  </td>
  <td>
    <input type="date" class="form-control form-control-sm" value="{{ d[7] or '' }}">
  </td>
  <td class="text-center no-print">
    <input type="checkbox" {% if d[8] %}checked{% endif %}>
  </td>

  <td class="no-print">
    {% if d[3] %}
    <a class="btn btn-sm btn-outline-primary" href="tel:{{ d[3] }}">
      <i class="bi bi-telephone-fill"></i>
    </a>
    {% endif %}

    {% if d[4] %}
    <a class="btn btn-sm btn-success" target="_blank" href="https://wa.me/{{ d[4] }}">
      <i class="bi bi-whatsapp"></i>
    </a>
    {% endif %}

    {% if d[3] %}
    <a class="btn btn-sm btn-outline-secondary" href="sms:{{ d[3] }}">
      <i class="bi bi-chat-dots-fill"></i>
    </a>
    {% endif %}
  </td>
</tr>
{% endfor %}
</tbody>

</table>
</div>

</div>

<!-- ================= SCRIPTS ================= -->
<script>
function updateSerial(){
  let i = 1;
  document.querySelectorAll("#dataTable tbody tr").forEach(r=>{
    if(r.style.display !== "none"){
      r.querySelector(".sr").innerText = i++;
    }
  });
}
updateSerial();

function filterCol(col,val){
  val = val.toLowerCase();
  document.querySelectorAll("#dataTable tbody tr").forEach(r=>{
    let cell = r.cells[col].innerText.toLowerCase();
    r.style.display = cell.includes(val) ? "" : "none";
  });
  updateSerial();
}

function exportTable(){
  let csv=[];
  document.querySelectorAll("#dataTable tr").forEach(r=>{
    let row=[];
    r.querySelectorAll("th,td").forEach(c=>{
      if(!c.classList.contains("no-print"))
        row.push('"'+c.innerText.replace(/"/g,'""')+'"');
    });
    csv.push(row.join(","));
  });
  let blob=new Blob([csv.join("\n")],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="debtors.csv";
  a.click();
}

function downloadBalanceSample(){
  let csv="Party Name,Closing Balance\nABC Traders,25000\nXYZ Industries,48000";
  downloadCSV(csv,"balance_sample.csv");
}
function downloadContactSample(){
  let csv="Party Name,Mobile No\nABC Traders,9876543210\nXYZ Industries,9123456789";
  downloadCSV(csv,"contact_sample.csv");
}
function downloadCSV(content,filename){
  let blob=new Blob([content],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}
</script>

</body>
</html>
